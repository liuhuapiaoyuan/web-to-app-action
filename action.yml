name: "Website to APK Action"
description: "Build folder path of html and creates an APK for it."
branding:
  color: 'blue'
  icon: 'smartphone'
inputs:
  build-folder-path: 
    description: "Path to build folder"
    required: false
    default: "build"

  app-name: 
    description: "Name of App"
    required: false
    default: "MyApp"

  app-package: 
    description: "package name of App"
    required: false
    default: "com.ggss.demoapp"

  output-folder-path:
    description: "Path to output folder"
    required: false
    default: "apk"
    
  app-keystore:
    description: "Path to keystore file"
    required: false

  app-alias:
    description: "Alias for keystore"
    required: false
    default: 'demo'

  store-password:
    description: "Password for keystore"
    required: false
    default: ''

  key-password:
    description: "Password for key"
    required: false 
    default: ''
    
runs:
  using: "composite"
  steps:
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17' 
        distribution: 'oracle'
        
    - uses: actions/setup-node@v2
      with:
        node-version: '18.x'
  
    - run: mkdir -p ionic_build_folder/build/
      shell: bash
    
    - name: Copy build files to ionic build folder
      run: cp -r ${{ inputs.build-folder-path }}/* ionic_build_folder/build
      shell: bash
      
    - name: Setup jq command
      shell: bash
      run: sudo apt-get install -y jq
    
    - name: Setup ionic and capacitor
      run: |
        npm install -g @ionic/cli
        npm init -y
        npm install @capacitor/core
        npm install @capacitor/cli --save-dev
        echo '{"appId": "${{ inputs.app-package }}","appName": "${{ inputs.app-name }}","bundledWebRuntime": false,"npmClient": "npm","webDir": "build","android":{},"cordova": {}}' > capacitor.config.json
        echo '{"name": "${{ inputs.app-name }}","integrations": {"capacitor": {}},"type": "react"}' > ionic.config.json
        cat capacitor.config.json 
        # Check if app-keystore is provided
        if [ -n "${{ inputs.app-keystore }}" ]; then
          echo "启动签名配置"
          echo '{"android":{"keystore":"${{inputs.app-keystore}}","alias":"${{inputs.app-alias}}","storePassword":"${{inputs.store-password}}","keyPassword":"${{inputs.key-password}}"}}' > capacitor.config.json.tmp
          # Merge with existing config
          cat capacitor.config.json.tmp
          jq -s '.[0] * .[1]' capacitor.config.json capacitor.config.json.tmp > capacitor.config.json
          rm capacitor.config.json.tmp
        fi
        cat ionic.config.json
        cat capacitor.config.json
        ionic capacitor add android
        cd android
        ./gradlew assembleDebug
        ./gradlew assembleRelease
      shell: bash
      working-directory: ionic_build_folder
    
    - name: Copy APK to output folder
      run: |
        mkdir -p ${{ inputs.output-folder-path }}
        cp -r ionic_build_folder/android/app/build/outputs/apk/ ${{ inputs.output-folder-path }}/
      shell: bash
